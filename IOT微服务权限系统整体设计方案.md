# IOT微服务权限系统整体设计方案

# 一、方案核心目标

围绕天文相机IOT微服务系统，实现**权限服务用户体系与IOT用户体系完全隔离**；权限系统仅保留超级管理员、管理员两类角色（公司内小用户体系），聚焦自身权限配置、账号管理及微服务鉴权提供，与设备权限无任何关联（规避用户隐私风险）；IOT侧优化为设备级三身份（owner/command/viewer），单个设备独立分配身份，用户可对不同设备拥有不同身份；新增授权链接机制适配新用户授权绑定；统计大屏为独立微服务，其用户归属权限服务的公司内小用户体系，与IOT系统分属不同用户中心，大屏的用户及权限鉴权统一调用权限系统提供的gRPC接口。整体兼顾权限管控安全性、实用性与极简性，适配天文相机个人用户设备量少的场景，与现有IOT微服务架构解耦，便于维护扩展。

# 二、整体架构设计

## 2.1 架构定位与双体系完全隔离

权限系统作为独立微服务（Permission Service），嵌入IOT天文相机系统，核心落实双体系完全隔离，两者无角色复用、无权限共享、无数据交织：

- 权限服务用户体系：仅用于权限服务自身的管理，仅包含超级管理员、管理员两类角色，不关联任何IOT设备操作，仅负责权限服务内部账号管理、权限规则配置。

- IOT用户体系：面向天文相机实际使用用户，无全局角色，仅以**单设备为维度**分配owner（拥有者）、command（控制者）、viewer（访客）三类身份，用户可对不同设备分别承担不同身份，仅处理设备相关操作；支持通过授权链接完成新用户授权，注册后自动绑定设备权限。

权限服务对外提供标准化gRPC鉴权接口，供IOT设备管理服务、统计大屏微服务调用，不侵入IOT及大屏业务逻辑；权限管理后台为独立前端系统，归属权限服务，仅对权限服务的超级管理员、管理员开放，完全脱离IOT用户中心；统计大屏为独立微服务，用户体系归属权限服务（公司内小用户体系），与IOT用户中心无关联，实现“权限配置、大屏鉴权、设备操作彻底分离”；权限服务双角色不触碰任何设备权限及用户授权数据，杜绝隐私泄露风险；IOT用户无权限访问权限管理后台及统计大屏。

## 2.2 依赖交互

- 与IOT用户管理服务：通过gRPC接口同步IOT用户基础信息、新增/删除事件（用于绑定设备身份），双体系用户数据独立存储、互不依赖，权限服务不存储IOT用户的设备操作记录，IOT系统不存储权限服务的管理数据，适配微服务内部高效交互。

- 与设备管理服务：通过gRPC接口接收设备操作（查看/控制）的权限校验请求，获取设备与IOT用户的身份关联关系，适配个人用户设备量少的场景，依托gRPC低延迟特性优化单设备权限查询效率。

- 与统计大屏微服务的交互：统计大屏为独立微服务，用户归属权限服务的公司内小用户体系，与IOT用户中心相互独立；大屏微服务通过gRPC接口调用权限服务的鉴权接口，完成用户身份及大屏访问权限校验，权限服务仅向自身超级管理员、管理员开放大屏访问权限，全程不涉及IOT设备及用户隐私数据，契合微服务间高效交互需求。

- 权限服务内部交互：独立管理后台通过HTTP接口与权限服务联动，仅允许超级管理员创建管理员账号、查看权限服务系统日志；管理员仅通过HTTP接口配置权限规则，不参与设备实际授权，不触碰任何设备及用户授权数据，规避隐私风险。

## 2.3 核心架构分层

1. 接口层：拆分两类接口，明确协议区分，适配不同交互场景——① HTTP接口：仅面向权限管理后台前端系统，仅对权限服务角色开放，支持超管创建管理员、管理员配置权限规则等管理操作，适配前端跨端访问需求；② gRPC接口：面向IOT设备管理服务、统计大屏微服务等下游微服务，提供统一的权限校验专属接口（判断用户身份及对应API访问权限），适配微服务内部高频调用、低延迟的交互需求，包括大屏微服务的鉴权及IOT设备操作的鉴权。

2. 业务逻辑层：拆分两类独立逻辑，互不干扰——① 权限服务管理逻辑：超管账号管理、权限系统日志查询、管理员权限管控；② IOT设备权限逻辑：基于设备级三身份（owner/command/viewer）校验权限，执行授权规则，处理授权链接生成、授权记录存储及新用户注册绑定逻辑。

3. 数据层：双体系数据完全隔离存储，权限服务侧仅存储自身用户、角色、权限规则、系统日志，不存储任何设备、IOT用户授权相关数据；IOT侧存储用户、设备、设备-用户身份关联、设备授权记录、授权链接信息，两者无数据交互，保障用户隐私。

4. 缓存层：分别缓存两类高频数据，权限服务侧缓存自身角色权限，IOT侧缓存设备-用户身份关联关系，适配个人用户设备量少的特点，提升校验性能，权限变更时实时刷新对应缓存。

# 三、核心权限模型设计

采用“RBAC模型（权限服务侧）+ 设备级身份授权（IOT侧）”的混合模型，双体系权限完全隔离，均遵循极简设计；权限服务双角色与设备权限彻底剥离以保护用户隐私，IOT侧优化为三身份适配细分需求，新增授权链接机制适配新用户场景。

## 3.1 核心概念定义

- 权限服务用户：仅归属权限服务体系，分为超级管理员、管理员，无IOT设备操作权限，仅负责权限服务内部管理。

- IOT用户：仅归属IOT体系，无全局角色，身份与设备绑定，可同时是设备A的owner、设备B的viewer，仅参与对应设备的操作。

- 权限服务角色：仅两类，独立配置、互不复用，仅作用于权限服务内部：① 超级管理员；② 管理员。

- IOT设备身份：单设备维度划分，共三类，作用于对应设备：① owner（拥有者）：设备全权限持有者；② command（控制者）：拥有设备查看与控制权限；③ viewer（访客）：仅拥有设备查看权限。

- 

    - 权限服务管理权限：仅面向权限服务角色，用于权限服务内部操作（账号创建、日志查看、权限规则配置），关联权限服务自身的管理类RESTful API（如管理员账号创建API、权限规则配置API），仅允许对应角色调用。

    - IOT设备操作权限：仅面向IOT设备身份，与设备绑定，分为设备查看、设备控制两类，关联IOT微服务的业务层面RESTful API（如设备参数查询API、拍摄控制API、授权链接生成API）；由权限服务管理员提前配置三类身份与对应API的绑定规则，新增授权链接相关的API权限校验逻辑，适配新用户注册绑定场景。

- 权限（Permission）：分为两类，完全隔离，均关联对应RESTful API权限（即接口访问权限，精准管控业务层面API调用）：

- 设备授权记录：仅记录IOT用户（某设备owner）向其他用户分配该设备身份的信息，包括授权链接生成、点击、绑定记录；权限服务用户不参与、不干预，不触碰该类数据，保障用户隐私。

- 权限规则：由权限服务管理员配置，核心包含两部分——① IOT侧：绑定设备三身份（owner/command/viewer）与对应IOT业务RESTful API的访问权限，全局生效；② 权限服务侧：绑定自身双角色与对应管理类RESTful API的访问权限；规则仅规范权限范围，不涉及具体设备授权及用户隐私数据。

## 3.2 角色/身份与权限映射设计

双体系权限完全隔离，权限服务侧聚焦自身管理，不触碰任何设备权限及用户授权数据（保护隐私）；IOT侧聚焦单设备操作，优化为三类身份适配细分需求，授权链接机制适配新用户场景，所有配置均通过权限服务独立管理后台完成（超管管理账号，管理员配置规则）。

### 3.2.1 权限服务侧（双角色）

|角色|核心权限|操作范围|
|---|---|---|
|超级管理员|1. 统计大屏访问（敏感数据全量访问），关联大屏访问权限校验类gRPC接口（供大屏微服务调用鉴权）；2. 创建/删除管理员账号，关联管理员账号管理类API；3. 查看权限服务系统日志，关联日志查询类API；4. 管控管理员操作权限，关联管理员权限管控类API；5. 不参与任何设备权限相关操作、不触碰用户授权数据，规避隐私风险。|仅权限服务管理、敏感数据查看，不干预IOT设备授权、不触碰设备及用户授权数据，不操作设备，保护用户隐私。|
|管理员|1. 统计大屏访问（敏感数据全量访问），关联大屏访问权限校验类gRPC接口（供大屏微服务调用鉴权）；2. 配置IOT侧设备三身份与IOT业务API的绑定规则、配置权限服务侧双角色与管理类API及大屏鉴权gRPC接口的绑定规则，关联权限规则配置类API；3. 无账号创建、日志查看权限，不参与设备授权、不触碰设备及用户授权数据，规避隐私风险。|仅权限规则配置、敏感数据查看，不参与IOT设备授权，不触碰设备及用户授权数据，不操作设备，保护用户隐私。|
### 3.2.2 IOT侧（单设备双身份）

|设备身份|核心权限（由管理员配置规则）|操作范围|
|---|---|---|
|owner（拥有者）|1. 对应设备的查看、控制权限，关联设备查询、参数读取、拍摄控制等IOT业务API；2. 生成授权链接，向其他用户分配该设备的owner/command/viewer身份，关联授权链接生成、设备身份分配类API；3. 回收该设备的授权，关联授权回收类API；4. 转移自身owner身份，关联身份转移类API；5. 无权限服务管理、大屏查看权限，无法调用对应管理类API。|仅对应单台设备的全量操作，不参与权限服务管理|
|command（控制者）|1. 对应设备的查看、控制权限，关联设备查询、参数读取、拍摄控制等IOT业务API；2. 无授权、回收、身份转移权限，无法调用授权生成、回收、身份转移类API；3. 无权限服务管理、大屏查看权限，无法调用对应管理类API。|仅对应单台设备的查看与控制操作，无授权管理权限|
|viewer（访客）|1. 对应设备的查看权限，仅关联设备查询、参数读取等只读类IOT业务API；2. 无设备控制、授权、回收、身份转移权限，无法调用控制类、授权类、身份转移类API；3. 无权限服务管理、大屏查看权限，无法调用对应管理类API。|仅对应单台设备的只读操作，无任何管理、控制权限|
## 3.3 设备权限核心规则

1. 初始身份分配：天文相机设备创建时，自动将该设备的owner身份分配给创建者（IOT用户），同步赋予该设备的查看、控制、授权、身份转移权限，无需手动操作。

2. 授权规则：仅某设备的owner可对该设备进行授权，授权方式支持生成授权链接；授权对象可为未注册新用户或已注册IOT用户，可选择分配owner/command/viewer身份，授权规则遵循权限服务管理员配置的标准；command、viewer无授权权限。

3. 身份独立性：同一IOT用户可对不同设备拥有不同身份（如设备A的owner、设备B的command），各设备身份独立、权限独立，互不影响；同一设备可拥有多个owner、command、viewer，适配少量协作场景。

4. 权限优先级：设备owner权限 > command权限 > viewer权限；权限服务超级管理员、管理员无任何设备权限优先级，不干预设备授权及操作，杜绝隐私泄露。

5. 权限回收：① 设备owner可随时回收其他用户对该设备的身份授权（回收后对方立即失去对应设备的操作权限）；② 设备owner变更：某设备的owner可将自身owner身份转移给其他IOT用户，转移后原owner失去该设备所有权限，新owner获得全量权限；③ 授权链接失效：授权链接可设置有效期，过期未使用自动失效；已使用的链接不可重复使用。

# 四、核心流程设计

## 4.1 权限服务侧管理流程

### 4.1.1 管理员账号创建流程

1. 发起操作：权限服务超级管理员通过独立管理后台，发起管理员账号创建请求，设置管理员账号信息及操作权限（仅开放“权限规则配置”“大屏查看”权限）。

2. 账号存储：校验通过后，创建管理员账号（归属权限服务用户体系），独立存储，与IOT用户账号完全隔离。

3. 日志记录：自动记录操作日志（操作人、创建时间、管理员账号信息），仅超级管理员可查看。

### 4.1.2 权限规则配置流程

1. 发起操作：管理员通过独立管理后台，配置两类RESTful API与角色/身份的绑定规则——① 权限服务侧：管理类API与超管、管理员的绑定；② IOT侧：设备操作类API与owner/command/viewer的绑定（如控制类API仅绑定owner、command）。

2. 规则存储：校验管理员权限后，保存规则并同步至缓存，规则全局生效，所有设备均遵循该规则。

3. 日志记录：记录规则配置/修改日志，仅超级管理员可查看该日志。

## 4.2 IOT侧设备授权流程（含授权链接机制）

### 4.2.1 已注册用户授权流程

1. 发起授权：某设备的owner（IOT用户）发起授权请求，选择授权对象（已注册IOT用户ID）、目标设备ID、分配身份（owner/command/viewer），可直接提交授权或生成授权链接。

2. 权限校验：权限服务调用预设规则，校验发起者是否为该设备的owner（仅owner可发起授权）。

3. 身份绑定/链接生成：直接授权则建立“授权对象-目标设备-分配身份”的关联关系；生成链接则创建含授权信息（设备ID、分配身份、有效期）的唯一授权链接，同步存储链接关联记录。

4. 通知反馈：直接授权成功后通知双方；生成链接后，owner可将链接分享给目标用户，返回链接生成结果及有效期提醒。

### 4.2.2 新用户授权绑定流程

1. 链接访问：新用户点击owner分享的授权链接，系统校验链接有效性（未过期、未使用）。

2. 注册引导：校验通过后，引导新用户完成IOT系统注册，不强制绑定权限服务相关信息。

3. 权限绑定：注册完成后，系统自动将授权链接对应的设备及身份（command/viewer/owner）绑定至新用户账号，同步存储授权记录。

4. 结果反馈：告知新用户授权绑定成功，展示绑定的设备及对应权限；同步通知授权发起者（owner）。

## 4.3 通用权限校验流程

所有操作均需经过校验，严格区分双体系操作边界，流程如下：

1. 请求发起：业务服务（IOT设备管理服务/统计大屏微服务）接收用户操作请求，携带用户ID、用户体系标识、操作类型、关联资源（设备ID/大屏访问权限）；其中大屏用户为权限服务体系用户，IOT用户为IOT体系用户，分属不同用户中心。

2. 校验请求：业务服务通过gRPC接口调用权限服务校验接口，明确用户所属体系及操作对象，适配微服务内部低延迟交互需求。

3. 多层校验：


    - 权限服务用户校验：适用于权限服务体系用户（含大屏访问用户、权限管理后台用户），先校验是否拥有对应管理权限/大屏访问权限，再校验是否具备该操作对应的API访问权限；若为大屏访问操作，由大屏微服务通过gRPC接口发起鉴权，校验通过则允许大屏数据访问；不涉及任何设备相关API校验、不触碰设备及用户授权数据，保护隐私。

    - IOT用户校验：若为IOT用户，先校验其对目标设备的身份（owner/command/viewer），再匹配管理员配置的“设备身份-RESTful API”绑定规则，校验是否具备该操作对应的IOT业务API访问权限，双重校验通过则允许操作；授权链接绑定的新用户，同步校验绑定有效性及对应API权限。

4. 结果返回：返回校验结果（通过/拒绝），拒绝时明确原因（无权限、身份不匹配、体系错误等）。

5. 业务执行：业务服务根据校验结果允许/拒绝操作，同步记录对应日志（权限服务日志/设备操作日志）。

## 4.4 设备owner身份转移流程

1. 发起转移：仅某设备的owner（IOT用户）可发起owner身份转移请求，提交目标设备ID、新owner（IOT用户）；权限服务双角色不可发起，避免触碰设备相关数据。

2. 权限校验：仅校验发起者是否为该设备的owner，权限服务双角色无校验及干预权限。

3. 身份调整：清除原owner与该设备的关联关系（回收所有权限），建立新owner与该设备的关联关系（赋予全量权限）。

4. 同步更新：更新IOT侧设备-用户身份关联数据，刷新缓存；仅记录IOT侧操作日志，权限服务双角色不可查看设备相关日志，保护隐私。

5. 通知反馈：通知原owner、新owner转移结果。

# 五、适配天文相机IOT场景的关键考量

## 5.1 双体系完全隔离适配

实现数据、角色、权限、操作的全维度隔离，权限服务仅负责“规则配置与自身管理”，不触碰任何设备权限及用户授权数据（保护隐私）；IOT系统仅负责“设备操作、身份授权及授权链接管理”，双方无数据交互，避免跨体系越权，同时简化排查流程。

## 5.2 贴合个人用户设备量少的优化

适配个人用户设备量少的特点，简化IOT侧授权流程，聚焦单设备授权（无需设备组），优化单设备身份查询、权限校验性能；缓存策略侧重单设备数据，减少冗余缓存，提升响应速度。

## 5.3 日志与审计适配

拆分三类独立日志，全流程可追溯且互不干扰，兼顾隐私保护：① 权限服务系统日志（仅超管查看，记录账号创建、规则配置）；② IOT设备授权日志（仅IOT系统可追溯，记录授权链接生成、设备身份分配/回收）；③ 设备操作日志（仅IOT系统可追溯，记录设备查看/控制操作）；权限服务双角色不可查看IOT侧两类日志，规避隐私泄露。

# 六、安全设计

- 双体系隔离安全：两类用户体系采用独立认证机制，账号密码、Token完全隔离，无跨体系认证通道，从根源避免跨体系越权。

- 敏感数据防护：统计大屏为独立微服务，用户归属权限服务的公司内小用户体系，与IOT用户中心完全隔离；大屏访问需通过gRPC接口完成鉴权，仅对权限服务双角色开放；所有日志、授权记录、大屏敏感数据均加密存储，敏感信息（用户ID、设备ID、大屏统计数据）脱敏展示；IOT用户无法访问权限管理后台及大屏，从源头规避敏感数据泄露。

- 接口安全：权限服务接口采用Token认证，严格区分双体系Token标识；核心操作（管理员账号创建、权限规则修改、设备owner转移）需二次校验（密码/验证码）。

- 应急管控：权限服务双角色无设备相关应急管控权限，不干预设备授权及操作；IOT侧应急管控由设备owner负责（如回收异常授权），保障用户隐私不被权限管理人员触碰。

# 七、扩展性设计

- 权限规则扩展：管理员通过HTTP接口新增IOT设备操作类、权限服务管理类RESTful API及大屏鉴权相关gRPC接口，同步更新身份/角色与API的绑定规则；微服务内部gRPC校验接口支持灵活扩展，适配新增API及新增微服务（含大屏）的鉴权需求，无需修改核心架构。

- IOT身份扩展：后续可新增设备级身份（如运维者，仅拥有控制权限无授权权限），适配多场景协作，不影响双体系隔离架构。

- 多租户适配：预留多租户字段，后续可扩展多租户场景，不同租户的双体系用户、权限规则、设备授权相互隔离，适配SaaS化部署需求。

# 八、方案总结

本方案完全落实双体系隔离、用户隐私保护及RESTful API与角色/身份的关联管控诉求，明确统计大屏为独立微服务，其用户归属权限服务的公司内小用户体系，与IOT系统分属不同用户中心，大屏鉴权统一调用权限系统提供的gRPC接口。同时区分接口协议分工——权限管理后台前端通过HTTP接口与权限服务联动，IOT设备管理、大屏微服务等下游微服务通过gRPC接口调用权限服务完成鉴权，适配微服务架构高频低延迟交互需求。权限服务仅保留超管、管理员双角色，聚焦自身管理类API与角色的绑定配置及全量微服务鉴权提供；IOT侧优化为owner、command、viewer三身份，同步完成IOT业务API与设备身份的绑定，新增授权链接机制适配新用户注册绑定，贴合极简实用思路。方案兼顾安全性、适配性与隐私保护，适配天文相机个人用户设备量少的场景，双体系及大屏与IOT的用户中心权责清晰、完全隔离，接口设计贴合微服务架构特点，明确了API层面的精细化管控逻辑及鉴权流程，不涉及具体代码实现，为后续开发提供清晰的整体设计指引，同时保留灵活的扩展空间，可适配后续业务迭代。
> （注：文档部分内容可能由 AI 生成）