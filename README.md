一、整体架构概览

```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用    │    │    API网关      │    │   认证服务      │
│                 │    │                 │    │                 │
│  Web/移动端/    │◄──►│  路由分发       │◄──►│  · 邮箱登录     │
│  第三方SDK      │    │  限流熔断       │    │  · OAuth登录    │
└─────────────────┘    └─────────────────┘    └────────┬────────┘
                                                        │
                ┌──────────────────────────────────────▼─────────────────────────────────────┐
                │                                                                             │
                │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
                │  │  用户主表    │  │ OAuth关联表  │  │  会话表      │  │  缓存层      │  │
                │  │  (users)     │◄─►│(user_external│◄─►│(user_sessions)│◄─►│ (Redis)     │  │
                │  │              │  │  _accounts)  │  │              │  │              │  │
                │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
                │                                                                             │
                └─────────────────────────────────────────────────────────────────────────────┘
```

二、邮箱注册流程

```text
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   用户提交   │────►│  验证请求参数 │────►│  检查邮箱    │────►│  密码加密    │
│  注册信息    │     │              │     │  唯一性      │     │             │
└─────────────┘     └──────────────┘     └──────┬──────┘     └─────────────┘
                                                 │                        │
                                                 ▼                        ▼
                                        ┌──────────────┐     ┌─────────────┐
                                        │  邮箱已存在   │     │  创建用户    │
                                        │    返回错误   │     │   记录      │
                                        └──────────────┘     └──────┬──────┘
                                                                    │
                                                                    ▼
                                                           ┌──────────────┐     ┌─────────────┐
                                                           │  发送验证邮件 │────►│  返回注册    │
                                                           │   (异步)     │     │   成功响应   │
                                                           └──────────────┘     └─────────────┘
```
#### 详细流程说明
* 请求接收与验证

客户端提交：邮箱、密码、确认密码

服务端验证：

邮箱格式合法性

密码强度（长度、复杂度）

密码与确认密码一致性

* 邮箱唯一性检查

查询 users 表：SELECT id FROM users WHERE email = ? AND deleted_at IS NULL

如果邮箱已注册：

返回错误："该邮箱已注册"

提供"忘记密码"链接

* 密码安全处理

使用 bcrypt/scrypt 算法加密密码

生成密码哈希值

绝不存储明文密码

* 创建用户记录

生成唯一用户ID（UUID）

插入 users 表：
```sql
INSERT INTO users (id, email, password_hash, status, created_at) 
VALUES (?, ?, ?, 'pending', NOW())
```
初始状态设为 pending（待验证）

#### 邮箱验证流程（异步）

* 生成验证令牌（JWT或随机字符串）

* 设置过期时间（如24小时）

* 发送验证邮件（使用消息队列异步处理）需要支持多语种：
```text
主题：请验证您的邮箱
内容：包含验证链接：https://api.example.com/auth/verify-email?token=xxx
安全提示：链接24小时内有效
```

#### 响应返回

响应体：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "user_id": "uuid",
    "email": "user@example.com"
  },
  "timestamp": 1769675327
}
```

### 邮箱登录流程

```text
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   用户提交   │────►│  验证请求参数 │────►│  查找用户    │────►│  验证用户    │
│  登录凭证    │     │              │     │   记录       │     │   状态       │
└─────────────┘     └──────────────┘     └──────┬──────┘     └──────┬──────┘
     │                                           │                    │
     │                                           ▼                    ▼
     │                                  ┌──────────────┐     ┌─────────────┐
     │                                  │  用户不存在   │     │  状态无效    │
     │                                  │  返回错误     │     │  (未验证/禁用)│
     │                                  └──────────────┘     └─────────────┘
     │                                           │                    │
     │                                           └──────┬─────────────┘
     │                                                  │
     ▼                                                  ▼
┌─────────────┐     ┌──────────────┐            ┌─────────────┐
│  密码验证   │◄────┤  密码哈希对比  │            │  返回错误    │
│             │     │              │            │  信息        │
└─────────────┘     └──────┬───────┘            └─────────────┘
     │                     │
     ▼                     ▼
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│  验证成功   │     │  验证失败     │     │  单点登录    │     │  更新最后    │
│             │     │   (密码错误)  │     │   检查       │     │  登录信息    │
└──────┬──────┘     └──────────────┘     └──────┬──────┘     └──────┬──────┘
       │                                        │                    │
       ▼                                        ▼                    ▼
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│  创建会话    │────►│  生成令牌     │────►│  存储会话    │────►│  返回登录    │
│             │     │   (JWT)      │     │   信息       │     │   成功响应   │
└─────────────┘     └──────────────┘     └─────────────┘     └─────────────┘
```
#### 详细流程说明
* 请求接收

客户端提交：邮箱、密码

可选设备信息：User-Agent、设备ID、IP地址

查找用户记录
```sql
SELECT id, email, password_hash, status, email_verified 
FROM users 
WHERE email = ? AND deleted_at IS NULL
```
如果用户不存在：返回"邮箱或密码错误"（避免透露具体信息）

* 验证用户状态

检查 status 字段：

pending：未验证邮箱，提示验证

suspended：账号已禁用，联系客服

deleted：账号已删除

检查 email_verified：如为false，可要求重新发送验证邮件

* 密码验证

使用 bcrypt 对比输入密码与存储的哈希值

密码错误处理：

记录失败次数（防暴力破解）

达到阈值后锁定账号或增加验证码

返回通用错误："邮箱或密码错误"

* 单点登录（SSO）检查

检查用户当前是否有活跃会话：
```sql
SELECT id FROM user_sessions 
WHERE user_id = ? AND revoked = FALSE AND expires_at > NOW()
```
